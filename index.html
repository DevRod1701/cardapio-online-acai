<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A√ßa√≠ do Lucca - Card√°pio Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Montserrat:wght@700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; padding-bottom: 120px; }
        h1, h2, h3 { font-family: 'Montserrat', sans-serif; }
        .purple-gradient { background: linear-gradient(135deg, #4c1d95 0%, #7c3aed 100%); }
        .card-shadow { box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.08); }
        
        @media print {
            @page { size: A4; margin: 1cm; }
            .no-print { display: none !important; }
            body { background: white !important; padding-bottom: 0; }
            main { max-width: 100% !important; padding: 0 !important; }
            section { page-break-inside: avoid; margin-bottom: 20px !important; border-bottom: 1px solid #eee; padding-bottom: 10px; }
            .purple-gradient { background: #4c1d95 !important; -webkit-print-color-adjust: exact; color: white !important; }
        }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; align-items: flex-end; backdrop-filter: blur(4px); }
        .modal.active { display: flex; }
        .modal-content { background: white; width: 100%; max-height: 90vh; overflow-y: auto; border-radius: 2.5rem 2.5rem 0 0; padding: 2rem; }
        
        .cart-float { transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .cart-float.active { transform: translateY(0); }

        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid #7c3aed; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .platform-btn { transition: all 0.2s; border: 1px solid #f3f4f6; }
        .platform-btn:hover { transform: scale(1.05); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        /* Estilo para op√ß√µes de pagamento */
        .pay-option input:checked + div { border-color: #7c3aed; background-color: #f5f3ff; color: #7c3aed; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Cabe√ßalho -->
    <header class="purple-gradient text-white py-14 px-4 text-center rounded-b-[3.5rem] shadow-xl relative overflow-hidden">
        <div class="max-w-4xl mx-auto relative z-10">
            <h1 class="text-4xl md:text-5xl font-extrabold uppercase tracking-tighter mb-1">A√ßa√≠ do Lucca</h1>
            <p class="text-purple-100 text-base md:text-lg font-medium opacity-90 tracking-wide">O melhor a√ßa√≠ da Vila Cisper</p>
        </div>
    </header>

    <main class="max-w-3xl mx-auto px-4 py-8 space-y-12">
        <!-- OS MAIS PEDIDOS -->
        <section>
            <div class="flex items-center mb-6 text-purple-900">
                <i data-lucide="star" class="w-5 h-5 mr-2 fill-yellow-500 text-yellow-500"></i>
                <h2 class="text-xl font-bold uppercase tracking-tight">Os Favoritos</h2>
            </div>
            <div class="grid md:grid-cols-2 gap-4">
                <div class="bg-white p-6 rounded-[2rem] card-shadow border border-purple-50 flex flex-col justify-between">
                    <div>
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-gray-900">A√ßa√≠ em Dobro</h3>
                            <span class="text-purple-700 font-bold">R$ 49,90</span>
                        </div>
                        <p class="text-gray-500 text-xs mt-1 leading-relaxed">2 Copos de 300ml completos para dividir ou dobrar sua felicidade.</p>
                    </div>
                    <button onclick="openCustomizer('A√ßa√≠ em Dobro', 49.90, 'a√ßai')" class="mt-4 w-full py-3 bg-purple-50 text-purple-700 rounded-2xl font-bold text-sm hover:bg-purple-100 no-print transition-colors">Personalizar</button>
                </div>

                <div class="bg-white p-6 rounded-[2rem] card-shadow border border-purple-50 flex flex-col justify-between">
                    <div>
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-gray-900">Fondue Especial</h3>
                            <span class="text-purple-700 font-bold">R$ 39,99</span>
                        </div>
                        <p class="text-gray-500 text-xs mt-1 leading-relaxed">Cremes artesanais, brownie quentinho, uvas e morangos frescos.</p>
                    </div>
                    <button onclick="addToCartDirectly('Fondue Especial', 39.99)" class="mt-4 w-full py-3 bg-purple-600 text-white rounded-2xl font-bold text-sm hover:bg-purple-700 no-print shadow-md">Adicionar</button>
                </div>
            </div>
        </section>

        <!-- A√áA√ç TRADICIONAL -->
        <section>
            <div class="flex items-center mb-6 text-purple-900">
                <i data-lucide="heart" class="w-5 h-5 mr-2 fill-purple-600"></i>
                <h2 class="text-xl font-bold uppercase tracking-tight">A√ßa√≠ Tradicional</h2>
            </div>
            <div class="space-y-3">
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100 flex justify-between items-center group transition-all hover:border-purple-200">
                    <div>
                        <h3 class="font-bold text-gray-900 text-lg">Copo 300ml</h3>
                        <p class="text-xs text-gray-400">Escolha 4 complementos gr√°tis.</p>
                        <span class="text-purple-700 font-bold">R$ 29,99</span>
                    </div>
                    <button onclick="openCustomizer('Copo 300ml', 29.99, 'a√ßai')" class="bg-purple-600 text-white px-6 py-3 rounded-2xl text-xs font-bold no-print shadow-sm">Personalizar</button>
                </div>
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100 flex justify-between items-center">
                    <div>
                        <h3 class="font-bold text-gray-900 text-lg">Copo 500ml</h3>
                        <p class="text-xs text-gray-400">Escolha 4 complementos gr√°tis.</p>
                        <span class="text-purple-700 font-bold">R$ 38,99</span>
                    </div>
                    <button onclick="openCustomizer('Copo 500ml', 38.99, 'a√ßai')" class="bg-purple-600 text-white px-6 py-3 rounded-2xl text-xs font-bold no-print shadow-sm">Personalizar</button>
                </div>
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100 flex justify-between items-center">
                    <div>
                        <h3 class="font-bold text-gray-900 text-lg">A√ßa√≠ na Marmita</h3>
                        <span class="text-purple-700 font-bold">R$ 40,99</span>
                    </div>
                    <button onclick="openCustomizer('A√ßa√≠ na Marmita', 40.99, 'a√ßai')" class="bg-purple-600 text-white px-6 py-3 rounded-2xl text-xs font-bold no-print shadow-sm">Personalizar</button>
                </div>
            </div>
        </section>

        <!-- SALADA DE FRUTAS -->
        <section>
            <div class="flex items-center mb-6 text-orange-600">
                <i data-lucide="citrus" class="w-5 h-5 mr-2"></i>
                <h2 class="text-xl font-bold uppercase tracking-tight">Salada de Frutas</h2>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-orange-50 p-6 rounded-[2.5rem] border border-orange-100 text-center">
                    <h3 class="font-bold text-orange-900 text-sm">Copo 300ml</h3>
                    <p class="text-orange-700 font-bold mb-3">R$ 22,99</p>
                    <button onclick="openCustomizer('Salada 300ml', 22.99, 'salada')" class="w-full bg-white text-orange-600 py-3 rounded-2xl text-xs font-bold shadow-sm no-print hover:bg-orange-600 hover:text-white transition-all">Personalizar</button>
                </div>
                <div class="bg-orange-50 p-6 rounded-[2.5rem] border border-orange-100 text-center">
                    <h3 class="font-bold text-orange-900 text-sm">Copo 500ml</h3>
                    <p class="text-orange-700 font-bold mb-3">R$ 29,99</p>
                    <button onclick="openCustomizer('Salada 500ml', 29.99, 'salada')" class="w-full bg-white text-orange-600 py-3 rounded-2xl text-xs font-bold shadow-sm no-print hover:bg-orange-600 hover:text-white transition-all">Personalizar</button>
                </div>
            </div>
        </section>

        <!-- ADICIONAIS EXTRA -->
        <section class="pb-10">
            <div class="flex items-center mb-6 text-green-700">
                <i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i>
                <h2 class="text-xl font-bold uppercase tracking-tight">Algo a mais?</h2>
            </div>
            <div class="bg-white rounded-[2rem] card-shadow overflow-hidden border border-gray-100">
                <div id="extra-list" class="divide-y divide-gray-50"></div>
            </div>
        </section>
    </main>

    <!-- Bot√£o de Impress√£o Flutuante -->
    <button onclick="window.print()" class="no-print fixed bottom-32 right-6 w-12 h-12 bg-white text-gray-400 rounded-full shadow-lg flex items-center justify-center border border-gray-100 z-40 hover:text-purple-600 transition-colors" title="Imprimir Card√°pio">
        <i data-lucide="printer" class="w-5 h-5"></i>
    </button>

    <!-- Modal de Checkout -->
    <div id="modal-checkout" class="modal no-print" onclick="closeModal('modal-checkout', event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black text-gray-900 tracking-tight">Finalizar Pedido</h2>
                <button onclick="closeModal('modal-checkout')" class="p-2 bg-gray-50 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="space-y-6 mb-8">
                <!-- Dados de Entrega -->
                <div class="space-y-3">
                    <input type="text" id="cust-name" placeholder="Qual o seu nome?" class="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl focus:border-purple-600 outline-none">
                    <div class="grid grid-cols-3 gap-4">
                        <div class="col-span-2 relative">
                            <input type="text" id="cust-cep" placeholder="CEP (00000-000)" maxlength="9" onkeyup="handleCep(this)" class="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl outline-none focus:border-purple-600">
                            <div id="cep-loading" class="absolute right-4 top-4 hidden"><div class="loading-spinner"></div></div>
                        </div>
                        <input type="text" id="cust-num" placeholder="N¬∫" class="w-full p-4 bg-gray-50 border border-gray-100 rounded-2xl outline-none">
                    </div>
                    <div id="address-box" class="hidden p-5 bg-purple-50 rounded-3xl border border-purple-100">
                        <p id="full-address" class="text-sm text-purple-900 font-bold mb-1"></p>
                        <div class="flex justify-between items-center border-t border-purple-200 pt-2 mt-2">
                            <span class="text-[10px] text-purple-400 font-bold uppercase">Frete</span>
                            <span id="fee-value" class="text-sm font-black text-purple-700">R$ 0,00</span>
                        </div>
                    </div>
                </div>

                <!-- Pagamento -->
                <div id="payment-section" class="space-y-4">
                    <h3 class="text-xs font-bold uppercase text-gray-400 tracking-widest ml-2">Pagamento</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="pay-option cursor-pointer">
                            <input type="radio" name="payment" value="PIX" class="hidden peer" onchange="toggleCashInput(false)">
                            <div class="p-4 border border-gray-100 rounded-2xl text-center text-sm font-bold transition-all peer-checked:border-purple-600">PIX</div>
                        </label>
                        <label class="pay-option cursor-pointer">
                            <input type="radio" name="payment" value="Dinheiro" class="hidden peer" onchange="toggleCashInput(true)">
                            <div class="p-4 border border-gray-100 rounded-2xl text-center text-sm font-bold transition-all peer-checked:border-purple-600">Dinheiro</div>
                        </label>
                        <label class="pay-option cursor-pointer">
                            <input type="radio" name="payment" value="Cart√£o de D√©bito" class="hidden peer" onchange="toggleCashInput(false)">
                            <div class="p-4 border border-gray-100 rounded-2xl text-center text-sm font-bold transition-all peer-checked:border-purple-600">D√©bito</div>
                        </label>
                        <label class="pay-option cursor-pointer">
                            <input type="radio" name="payment" value="Cart√£o de Cr√©dito" class="hidden peer" onchange="toggleCashInput(false)">
                            <div class="p-4 border border-gray-100 rounded-2xl text-center text-sm font-bold transition-all peer-checked:border-purple-600 text-xs">Cr√©dito<br><span class="opacity-50 font-medium">Visa/Master/Elo</span></div>
                        </label>
                    </div>

                    <!-- Troco -->
                    <div id="cash-change-box" class="hidden space-y-2 animate-in fade-in slide-in-from-top-2">
                        <div class="bg-gray-50 p-4 rounded-2xl border border-gray-100">
                            <label class="text-[10px] uppercase font-bold text-gray-400 mb-1 block">Troco para quanto?</label>
                            <input type="number" id="cash-amount" placeholder="Ex: 50" oninput="calculateChange()" class="w-full bg-transparent font-bold text-lg outline-none">
                        </div>
                        <div id="change-result" class="hidden text-center p-3 bg-green-50 rounded-2xl border border-green-100">
                            <span class="text-xs text-green-600 font-bold uppercase tracking-wider">Seu Troco: </span>
                            <span id="change-value" class="text-base font-black text-green-700 ml-1">R$ 0,00</span>
                        </div>
                    </div>
                </div>

                <!-- Parceiros (Fora de √Årea) -->
                <div id="out-of-range" class="hidden p-6 bg-white rounded-[2.5rem] border-2 border-dashed border-gray-200 space-y-6 text-center">
                    <p class="text-lg text-gray-900 font-black tracking-tight leading-tight">Poxa.. Infelizmente n√£o entregamos no seu endere√ßo, mas n√£o fique sem o seu a√ßa√≠!</p>
                    <div class="grid grid-cols-3 gap-4">
                        <a href="https://www.ifood.com.br/delivery/sao-paulo-sp/acai-do-lucca-parque-cisper/1fd17658-98b4-4f9b-a154-20cf834d7ed3" target="_blank" class="platform-btn bg-white p-3 rounded-2xl flex items-center justify-center">
                            <img src="./ifood.png" class="w-full h-12 object-contain" alt="iFood">
                        </a>
                        <a href="https://url-eu.mykeeta.com/uCMXP3uz" target="_blank" class="platform-btn bg-white p-3 rounded-2xl flex items-center justify-center">
                            <img src="./keeta.png" class="w-full h-12 object-contain" alt="Keeta">
                        </a>
                        <a href="https://oia.99app.com/dlp9/TEjllm" target="_blank" class="platform-btn bg-white p-3 rounded-2xl flex items-center justify-center">
                            <img src="./99.png" class="w-full h-12 object-contain" alt="99 Food">
                        </a>
                    </div>
                </div>
            </div>

            <button id="btn-final-order" onclick="sendWhatsApp()" class="w-full bg-green-600 text-white py-5 rounded-[1.5rem] font-bold text-lg shadow-xl shadow-green-100 opacity-50 cursor-not-allowed transition-all" disabled>
                Concluir Pedido
            </button>
        </div>
    </div>

    <!-- Modais de Apoio -->
    <div id="modal-custom" class="modal no-print" onclick="closeModal('modal-custom', event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 id="modal-title" class="text-2xl font-black text-gray-900 tracking-tight">Personalizar</h2>
                    <p id="modal-subtitle" class="text-sm text-gray-500 font-medium italic">Selecione at√© 4 gr√°tis</p>
                </div>
                <button onclick="closeModal('modal-custom')" class="p-2 bg-gray-50 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="topping-options" class="space-y-2 mb-8"></div>
            <button onclick="confirmToppings()" class="w-full bg-purple-600 text-white py-5 rounded-[1.5rem] font-bold text-lg shadow-lg active:scale-95 transition-transform">
                Confirmar
            </button>
        </div>
    </div>

    <div id="modal-cart" class="modal no-print" onclick="closeModal('modal-cart', event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black text-gray-900 tracking-tight">Cesto de Del√≠cias</h2>
                <button onclick="closeModal('modal-cart')" class="p-2 bg-gray-50 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="cart-items-list" class="space-y-4 mb-8"></div>
            <button onclick="openCheckout()" class="w-full bg-purple-600 text-white py-5 rounded-[1.5rem] font-bold text-lg shadow-xl shadow-purple-100">
                Continuar
            </button>
        </div>
    </div>

    <div id="cart-bar" class="no-print cart-float fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 px-6 py-6 shadow-2xl z-50 rounded-t-[2.5rem]">
        <div class="max-w-3xl mx-auto flex items-center justify-between gap-4">
            <div class="flex flex-col text-left">
                <span class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">Total</span>
                <span id="cart-total-bar" class="text-2xl font-black text-gray-900 tracking-tighter">R$ 0,00</span>
            </div>
            <button onclick="openCart()" class="flex-1 bg-purple-900 text-white py-4 px-6 rounded-[1.25rem] font-bold flex items-center justify-center gap-2 shadow-lg shadow-purple-100">
                <i data-lucide="shopping-bag" class="w-5 h-5"></i>
                Revisar (<span id="cart-count">0</span>)
            </button>
        </div>
    </div>

    <footer class="bg-gray-100 text-center py-12 px-4 mt-10 no-print">
        <p class="text-gray-400 text-xs font-bold uppercase tracking-widest">A√ßa√≠ do Lucca ‚Ä¢ Vila Cisper</p>
        <p class="text-gray-400 text-[10px] mt-2 uppercase opacity-50 tracking-widest">Obrigado pela prefer√™ncia!</p>
    </footer>

    <script>
        const STORE_LOCATION = { lat: -23.49102257465869, lon: -46.49390912179673, address: "Vila Cisper, S√£o Paulo" }; 
        const MAX_RADIUS_KM = 3; 
        const EXCLUDED_CITIES = ['guarulhos'];
        const BLOCKED_PREFIX = '03828';

        const toppingsData = [
            { name: "Banana", price: 2.00, free: true, type: "fruta" },
            { name: "Manga", price: 4.00, free: true, type: "fruta" },
            { name: "Uvas Verdes", price: 5.00, free: true, type: "fruta" },
            { name: "Morangos", price: 10.00, free: true, type: "fruta" },
            { name: "Leite Condensado", price: 3.50, free: true, type: "doce" },
            { name: "Amendoim Triturado", price: 3.00, free: true, type: "a√ßai" },
            { name: "Granulado / Granola", price: 3.50, free: true, type: "a√ßai" },
            { name: "Confeti", price: 7.00, free: true, type: "a√ßai" },
            { name: "Pa√ßoquita (1un)", price: 2.00, free: true, type: "a√ßai" },
            { name: "Creme de Ninho", price: 5.00, free: false, type: "a√ßai" },
            { name: "Nutella (80g)", price: 10.00, free: false, type: "a√ßai" }
        ];

        let cart = [];
        let currentItem = null;
        let clientAddress = null;
        let deliveryFee = 0;

        function init() {
            lucide.createIcons();
            renderExtraList();
        }

        function renderExtraList() {
            const list = document.getElementById('extra-list');
            list.innerHTML = toppingsData.map(t => `
                <div class="p-5 flex justify-between items-center transition-all hover:bg-green-50/20">
                    <span class="text-sm font-bold text-gray-700">${t.name}</span>
                    <div class="flex items-center gap-3">
                        <span class="text-[10px] text-gray-400 font-bold">R$ ${t.price.toFixed(2)}</span>
                        <button onclick="addToCartDirectly('${t.name}', ${t.price})" class="w-9 h-9 rounded-xl bg-green-50 text-green-600 flex items-center justify-center hover:bg-green-600 hover:text-white transition-all shadow-sm"><i data-lucide="plus" class="w-5 h-5"></i></button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function openCustomizer(name, price, category) {
            currentItem = { name, basePrice: price, toppings: [], category: category };
            document.getElementById('modal-title').innerText = name;
            renderToppingOptions();
            document.getElementById('modal-custom').classList.add('active');
        }

        function renderToppingOptions() {
            const container = document.getElementById('topping-options');
            const isSalada = currentItem.category === 'salada';
            const filteredToppings = toppingsData.filter(t => isSalada ? (t.type === 'fruta' || t.name === 'Leite Condensado') : true);
            const freeCheckedCount = Array.from(document.querySelectorAll('input[name="topping"]:checked')).filter(cb => filteredToppings[parseInt(cb.value)]?.free).length;

            container.innerHTML = filteredToppings.map((t, index) => {
                const isChecked = currentItem.toppings.includes(index);
                let text = t.free && (freeCheckedCount < 4 || isChecked) ? "Gr√°tis" : `+ R$ ${t.price.toFixed(2)}`;
                let color = t.free && (freeCheckedCount < 4 || isChecked) ? "text-green-600" : "text-purple-600 font-bold";
                if (t.free && freeCheckedCount >= 4 && !isChecked) { color = "text-red-500 font-bold"; }
                return `
                    <label class="relative flex justify-between items-center p-5 rounded-3xl border border-gray-100 cursor-pointer transition-all hover:bg-gray-50">
                        <input type="checkbox" name="topping" value="${index}" ${isChecked ? 'checked' : ''} onchange="updateToppingSelection(this)" class="hidden peer">
                        <div class="absolute inset-0 border-2 border-transparent rounded-3xl peer-checked:border-purple-600 peer-checked:bg-purple-50/40 transition-all pointer-events-none"></div>
                        <div class="flex flex-col relative z-10">
                            <span class="font-bold text-gray-800">${t.name}</span>
                            <span class="text-[10px] uppercase tracking-widest ${color}">${text}</span>
                        </div>
                        <div class="w-7 h-7 rounded-full border-2 border-gray-200 peer-checked:bg-purple-600 peer-checked:border-purple-600 flex items-center justify-center relative z-10">
                             <i data-lucide="check" class="w-4 h-4 text-white"></i>
                        </div>
                    </label>
                `;
            }).join('');
            lucide.createIcons();
        }

        function updateToppingSelection(checkbox) {
            const index = parseInt(checkbox.value);
            if (checkbox.checked) currentItem.toppings.push(index);
            else currentItem.toppings = currentItem.toppings.filter(i => i !== index);
            renderToppingOptions();
        }

        function confirmToppings() {
            const isSalada = currentItem.category === 'salada';
            const filteredToppings = toppingsData.filter(t => isSalada ? (t.type === 'fruta' || t.name === 'Leite Condensado') : true);
            let finalPrice = currentItem.basePrice;
            let freeSlotsUsed = 0;
            let chosen = [];
            currentItem.toppings.sort((a,b) => a - b).forEach(idx => {
                const t = filteredToppings[idx];
                if (t.free && freeSlotsUsed < 4) { freeSlotsUsed++; chosen.push(t.name); }
                else { finalPrice += t.price; chosen.push(`${t.name} (+R$${t.price.toFixed(2)})`); }
            });
            cart.push({ id: Date.now(), name: currentItem.name, price: finalPrice, details: chosen.join(', ') });
            closeModal('modal-custom');
            updateCartUI();
        }

        function addToCartDirectly(name, price) {
            cart.push({ id: Date.now(), name, price, details: '' });
            updateCartUI();
        }

        function updateCartUI() {
            const total = cart.reduce((sum, item) => sum + item.price, 0);
            document.getElementById('cart-total-bar').innerText = `R$ ${total.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;
            document.getElementById('cart-count').innerText = cart.length;
            document.getElementById('cart-bar').classList.toggle('active', cart.length > 0);
        }

        function openCart() {
            const list = document.getElementById('cart-items-list');
            list.innerHTML = cart.length ? cart.map(item => `
                <div class="flex justify-between items-start bg-gray-50 p-5 rounded-3xl border border-gray-100">
                    <div class="flex-1 pr-4">
                        <h4 class="font-black text-gray-900 tracking-tight uppercase text-sm">${item.name}</h4>
                        <p class="text-[10px] text-gray-500 italic mt-1 leading-tight">${item.details}</p>
                        <span class="text-sm font-black text-purple-700 block mt-2">R$ ${item.price.toFixed(2)}</span>
                    </div>
                    <button onclick="removeFromCart(${item.id})" class="text-red-400 p-2"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                </div>
            `).join('') : '<p class="text-center text-gray-400 py-10 italic">Seu cesto est√° vazio...</p>';
            lucide.createIcons();
            document.getElementById('modal-cart').classList.add('active');
        }

        function removeFromCart(id) {
            cart = cart.filter(item => item.id !== id);
            updateCartUI();
            openCart();
            if (!cart.length) closeModal('modal-cart');
        }

        function openCheckout() {
            closeModal('modal-cart');
            document.getElementById('modal-checkout').classList.add('active');
        }

        async function handleCep(input) {
            const cep = input.value.replace(/\D/g, '');
            if (cep.length === 8) {
                document.getElementById('cep-loading').classList.remove('hidden');
                try {
                    const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                    const data = await response.json();
                    if (data.erro) { alert("Ops! CEP n√£o encontrado."); return; }
                    clientAddress = data;
                    document.getElementById('full-address').innerText = `${data.logradouro}, ${data.bairro} - ${data.localidade}`;
                    document.getElementById('address-box').classList.remove('hidden');
                    validateAddress(data);
                } catch (e) { console.error(e); } finally { document.getElementById('cep-loading').classList.add('hidden'); }
            }
        }

        async function validateAddress(addr) {
            const outOfRange = document.getElementById('out-of-range');
            const btn = document.getElementById('btn-final-order');
            const paymentSect = document.getElementById('payment-section');
            const feeDisplay = document.getElementById('fee-value');
            const cleanCep = addr.cep.replace(/\D/g, '');

            if (EXCLUDED_CITIES.includes(addr.localidade.toLowerCase()) || cleanCep.startsWith(BLOCKED_PREFIX)) {
                outOfRange.classList.remove('hidden');
                paymentSect.classList.add('hidden');
                btn.disabled = true;
                btn.classList.add('opacity-50');
                return;
            }

            const query = `${addr.logradouro}, ${addr.localidade}, Brazil`;
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const results = await response.json();
                if (results.length > 0) {
                    const lat = parseFloat(results[0].lat);
                    const lon = parseFloat(results[0].lon);
                    const distance = calculateDistance(STORE_LOCATION.lat, STORE_LOCATION.lon, lat, lon);
                    if (distance > MAX_RADIUS_KM) {
                        outOfRange.classList.remove('hidden');
                        paymentSect.classList.add('hidden');
                        btn.disabled = true;
                    } else {
                        if (distance <= 1) deliveryFee = 3.99;
                        else if (distance <= 2) deliveryFee = 4.99;
                        else deliveryFee = 5.99;
                        feeDisplay.innerText = `R$ ${deliveryFee.toFixed(2)}`;
                        outOfRange.classList.add('hidden');
                        paymentSect.classList.remove('hidden');
                        btn.disabled = false;
                        btn.classList.remove('opacity-50');
                    }
                }
            } catch (e) { btn.disabled = false; btn.classList.remove('opacity-50'); }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2-lat1)*Math.PI/180;
            const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function toggleCashInput(show) {
            document.getElementById('cash-change-box').classList.toggle('hidden', !show);
            if(!show) { document.getElementById('cash-amount').value = ''; document.getElementById('change-result').classList.add('hidden'); }
        }

        function calculateChange() {
            const totalItems = cart.reduce((sum, item) => sum + item.price, 0);
            const totalOrder = totalItems + deliveryFee;
            const paid = parseFloat(document.getElementById('cash-amount').value) || 0;
            const resBox = document.getElementById('change-result');
            const valSpan = document.getElementById('change-value');
            if (paid > totalOrder) {
                valSpan.innerText = `R$ ${(paid-totalOrder).toFixed(2)}`;
                resBox.classList.remove('hidden');
            } else { resBox.classList.add('hidden'); }
        }

        function sendWhatsApp() {
            const name = document.getElementById('cust-name').value;
            const num = document.getElementById('cust-num').value;
            const pay = document.querySelector('input[name="payment"]:checked')?.value;
            const cash = document.getElementById('cash-amount').value;
            if (!name || !num || !clientAddress || !pay) { alert("Preencha todos os dados e o pagamento!"); return; }

            let message = `*NOVO PEDIDO - A√áA√ç DO LUCCA*\n`;
            message += `==========================\n`;
            message += `*CLIENTE:* ${name}\n`;
            message += `*ENDERE√áO:* ${clientAddress.logradouro}, ${num}\n`;
            message += `*BAIRRO:* ${clientAddress.bairro}\n`;
            message += `==========================\n\n`;
            
            let totalItens = 0;
            cart.forEach((item, idx) => {
                message += `*${idx+1}. ${item.name.toUpperCase()}*\n`;
                if(item.details) message += `_Acomp: ${item.details}_\n`;
                message += `R$ ${item.price.toFixed(2)}\n\n`;
                totalItens += item.price;
            });

            const total = totalItens + deliveryFee;
            message += `==========================\n`;
            message += `*Subtotal:* R$ ${totalItens.toFixed(2)}\n`;
            message += `*Entrega:* R$ ${deliveryFee.toFixed(2)}\n`;
            message += `*TOTAL:* R$ ${total.toFixed(2)}\n\n`;
            message += `*PAGAMENTO:* ${pay}\n`;
            if (pay === 'Dinheiro' && cash) {
                message += `*Pagar com:* R$ ${parseFloat(cash).toFixed(2)}\n`;
                if(parseFloat(cash) > total) message += `*Troco:* R$ ${(parseFloat(cash)-total).toFixed(2)}\n`;
            }
            message += `\nLucca, pode preparar o meu! üç®üöÄ`;
            window.open(`https://wa.me/5511988170539?text=${encodeURIComponent(message)}`, '_blank');
        }

        function closeModal(id, e) { if (e && e.target !== e.currentTarget) return; document.getElementById(id).classList.remove('active'); }
        window.onload = init;
    </script>
</body>
</html>
